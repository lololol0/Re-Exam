<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
    <title>Чат</title>
    <script src="https://code.jquery.com/jquery-3.6.0.js"
            integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
            crossorigin="anonymous"></script>
</head>
<body>
<br><a href="/rooms" class="btn btn-secondary btn-sm">Назад на главную</a>

<div class="container mt-5">
    <h2>{{room_name}}</h2>
    <p>Создатель: {{admin}} </p>
    <p> {{type}} </p>

    <br>
    <h3> Сообщения </h3>
    <div id="content">

    </div>
    <form id="message_form">
        <input type="text" id="message_field" name="text" placeholder="Введите сообщение" class="form-control">
        <h2> </h2>
        <button type="submit" class="btn btn-secondary">Отправить</button>
    </form>
</div>
<div class="container mt-5">

    <h3>Пользователи:</h3>
    {{#users}}
        {{username}}<br>
    {{/users}}
    {{#is_admin}}

        <br>
        <br><h2>Редактирование</h2>
        <form action="/{{roomId}}/add_user" method="post">
            <input type="text" name="username" placeholder="введите имя пользователя" class="form-control">
            <h2> </h2>
            <button type="submit" class="btn btn-secondary">Добавить</button>
        </form>

        <!--    меняем имя комнаты-->
        <br>
        <form action="/{{roomId}}/updateNameRoom" method="post">
            <input type="text" name="title" placeholder="введите новое название комнаты" class="form-control">
            <h2> </h2>
            <button type="submit" class="btn btn-secondary">Изменить</button>
        </form>
        <br>

        <!--    меняем тип комнаты-->
        <form action="/{{roomId}}/updateType" method="post">
            <button type="submit" class="btn btn-secondary">Сделать: {{switched_type}}</button>
        </form><br>
        <br>
    {{/is_admin}}
</div>



</body>
<script type="text/javascript">
    const form = $("#message_form");
    form.submit(function (e) {
        $.ajax({
            url: "/{{roomId}}/send_message",
            method: 'POST',
            data: jQuery.param({text: $("#message_field").val()}),
            success: () => {
                form[0].reset();
                doRefresh();
            }
        });
        e.preventDefault();
    });
    function doRefresh() {
        $.ajax({
            url: "/api/{{roomId}}/all-messages",
            dataType: "text",
            success: function (data) {
                const json = $.parseJSON(data);
                $("#content").html(
                        json["messages"].map(function (msg) {
                            return "<br><b>" + msg["stringDate"] + "<br>" + msg["username"] + ":</b> " + msg["message"] + "</br>";
                        }).join("\n")
                );
            }
        });
    }
    doRefresh();
    $(function () {
        setInterval(doRefresh, 1000);
    });
</script>
</html>